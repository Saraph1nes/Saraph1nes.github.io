---
title: é£æ§éªŒè¯ç ç»„ä»¶æ¶æ„è®¾è®¡ä¸å®ç°
date: 2025-11-24
tags: 
  - æ¶æ„è®¾è®¡
  - React
  - Taro
  - å°ç¨‹åº
  - å‘å¸ƒè®¢é˜…
  - ç»„ä»¶è®¾è®¡
---

# é£æ§éªŒè¯ç ç»„ä»¶æ¶æ„è®¾è®¡ä¸å®ç°

> âœ¨æ–‡ç« æ‘˜è¦ï¼ˆAIç”Ÿæˆï¼‰

<!-- DESC SEP -->

æœ¬æ–‡æ·±å…¥æ¢è®¨äº†å°ç¨‹åºé£æ§éªŒè¯ç ç»„ä»¶çš„æ¶æ„è®¾è®¡ä¸æ¼”è¿›å†ç¨‹ã€‚ä»æ—§æ–¹æ¡ˆçš„ Layout æ³¨å†Œ-å›è°ƒæ¨¡å¼å‡ºå‘ï¼Œåˆ†æäº†ç”Ÿå‘½å‘¨æœŸç®¡ç†å¤æ‚ã€å¤šå®ä¾‹æ€§èƒ½é—®é¢˜ä»¥åŠä¸¥é‡çš„é¡µé¢å¡é¡¿ BUGã€‚é€šè¿‡å¼•å…¥äº‹ä»¶å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œåˆ©ç”¨å°ç¨‹åºåº•å±‚çš„é¡µé¢å”¯ä¸€æ ‡è¯†æœºåˆ¶å®ç°è‡ªåŠ¨è·¯ç”±ï¼Œç»“åˆåŒå‘ Promise ä¼ é€’é“¾è·¯å’Œäº‹ä»¶é˜Ÿåˆ—æœºåˆ¶ï¼Œå®Œç¾è§£å†³äº†è·¨é¡µé¢è°ƒç”¨ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€å¹¶å‘æ§åˆ¶ç­‰æŠ€æœ¯éš¾é¢˜ã€‚æ–°æ–¹æ¡ˆä»£ç é‡å‡å°‘çº¦ 37.5%ï¼Œæ¶æ„æ›´åŠ ä¼˜é›…ï¼Œä¸ºå°ç¨‹åºä¸­çš„å…¨å±€ç»„ä»¶è°ƒç”¨æä¾›äº†æœ€ä½³å®è·µå‚è€ƒã€‚

<!-- DESC SEP -->

## ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜

### 1.1 ä¸šåŠ¡åœºæ™¯

åœ¨ç”µå•†å°ç¨‹åºä¸­ï¼Œä¸ºäº†é˜²æ­¢æ¶æ„æ”»å‡»å’Œåˆ·å•è¡Œä¸ºï¼Œéœ€è¦åœ¨å…³é”®æ¥å£ï¼ˆå¦‚ç™»å½•ã€ä¸‹å•ã€æ”¯ä»˜ç­‰ï¼‰é›†æˆé£æ§éªŒè¯ç åŠŸèƒ½ã€‚éªŒè¯ç éœ€è¦åœ¨è¯·æ±‚æ‹¦æˆªå™¨ç­‰é React ç»„ä»¶ä¸­è§¦å‘ï¼ŒåŒæ—¶è¦ä¿è¯ç”¨æˆ·ä½“éªŒæµç•…ã€‚

### 1.2 æŠ€æœ¯æŒ‘æˆ˜

1. **è·¨é¡µé¢è°ƒç”¨**ï¼šè¯·æ±‚æ‹¦æˆªå™¨æ˜¯å…¨å±€å•ä¾‹ï¼Œéœ€è¦åœ¨ä»»æ„é¡µé¢è§¦å‘éªŒè¯ç 
2. **å¤šå®ä¾‹é—®é¢˜**ï¼šæ¯ä¸ªé¡µé¢éƒ½æœ‰ç‹¬ç«‹çš„ç»„ä»¶å®ä¾‹ï¼Œå¦‚ä½•é¿å…é‡å¤åˆ›å»ºéªŒè¯ç ç»„ä»¶
3. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šé¡µé¢åˆ‡æ¢æ—¶å¦‚ä½•æ­£ç¡®ç®¡ç†éªŒè¯ç å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸ
4. **Promise å¼‚æ­¥å¤„ç†**ï¼šéªŒè¯ç éªŒè¯æ˜¯å¼‚æ­¥çš„ï¼Œéœ€è¦ä¼˜é›…çš„ Promise å¤„ç†æ–¹æ¡ˆ

---

## äºŒã€æ¶æ„æ¼”è¿›å†ç¨‹

### 2.1 æ—§æ–¹æ¡ˆï¼šLayout æ³¨å†Œ-å›è°ƒæ¨¡å¼

#### å®ç°æ–¹å¼

```typescript
// Layout ç»„ä»¶
const Layout = () => {
  const [showCaptchaModal, setShowCaptchaModal] = useState(false);
  const promiseRef = useRef<{resolve, reject} | null>(null);
  
  // æ¯ä¸ªé¡µé¢æ³¨å†Œåˆ° RiskControlManager
  useEffect(() => {
    const handlerId = riskControlManager.registerHandlers(
      showCaptcha,
      hideCaptcha,
    );
    return () => {
      riskControlManager.unregisterHandlers(handlerId);
    };
  }, [showCaptcha, hideCaptcha]);
  
  return (
    <>
      {children}
      <DxCaptcha
        ref={captchaRef}
        show={showCaptchaModal}
        onSuccess={handleCaptchaSuccess}
        onHide={handleCaptchaHide}
      />
    </>
  );
};

// RiskControlManager
class RiskControlManager {
  private handlers = new Map<string, {show, hide}>();
  private currentHandlerId: string;
  
  registerHandlers(show, hide) {
    const id = generateId();
    this.handlers.set(id, {show, hide});
    return id;
  }
  
  async showCaptcha() {
    const handler = this.handlers.get(this.currentHandlerId);
    return handler.show();
  }
}
```

#### å­˜åœ¨çš„é—®é¢˜

| é—®é¢˜ç±»å‹ | å…·ä½“è¡¨ç° | å½±å“ |
|---------|---------|------|
| **ç”Ÿå‘½å‘¨æœŸå¤æ‚** | æ¯ä¸ªé¡µé¢æŒ‚è½½æ—¶æ³¨å†Œï¼Œå¸è½½æ—¶æ³¨é”€ | å®¹æ˜“é—æ¼ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ |
| **ä¾èµ–æ›´æ–°é£é™©** | `useEffect([showCaptcha, hideCaptcha])` ä¾èµ–å‡½æ•°å¼•ç”¨ | å‡½æ•°å¼•ç”¨å˜åŒ–ä¼šå¯¼è‡´é¢‘ç¹é‡æ–°æ³¨å†Œ |
| **æ˜ å°„è¡¨ç»´æŠ¤** | éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ `Map<handlerId, handlers>` | å¢åŠ ä»£ç å¤æ‚åº¦ |
| **æ‰¾ä¸åˆ° handler** | æ³¨å†Œå¤±è´¥æˆ–æ—¶åºé”™è¯¯æ—¶ `handlers.get()` è¿”å› undefined | å¯¼è‡´éªŒè¯ç æ— æ³•æ˜¾ç¤º |
| **å¤šå®ä¾‹æµªè´¹** | æ¯ä¸ªé¡µé¢éƒ½åˆ›å»ºç‹¬ç«‹çš„ `DxCaptcha` å®ä¾‹ | æ€§èƒ½é—®é¢˜ï¼ˆæ³¨é‡Šä¸­æ ‡æ³¨ `// TODO è§£å†³æ€§èƒ½é—®é¢˜`ï¼‰ |
| **âš ï¸ ä¸¥é‡BUG** | **åå¤è¿›å‡ºå•†è¯¦é¡µåï¼ŒæŸæ¬¡è¿›å…¥ä¼šå¡åœ¨loading** | **ç”Ÿäº§ç¯å¢ƒä¸¥é‡é—®é¢˜ï¼Œå½±å“æ ¸å¿ƒä¸šåŠ¡æµç¨‹** |

##### ğŸ”´ ä¸¥é‡é—®é¢˜è¯¦è§£ï¼šé¡µé¢åå¤è¿›å‡ºåå¡ä½

**é—®é¢˜ç°è±¡ï¼š**
- ç”¨æˆ·åœ¨é¦–é¡µå’Œå•†è¯¦é¡µä¹‹é—´åå¤è·³è½¬ï¼ˆå¦‚ï¼šé¦–é¡µ â†’ å•†è¯¦ â†’ è¿”å› â†’ å•†è¯¦ â†’ è¿”å› â†’ å•†è¯¦...ï¼‰
- æŸä¸€æ¬¡è¿›å…¥å•†è¯¦é¡µæ—¶ï¼Œé¡µé¢å¡åœ¨ loading çŠ¶æ€ï¼Œæ— æ³•åŠ è½½
- æ³¨é‡Šæ‰é£æ§ç»„ä»¶åé—®é¢˜æ¶ˆå¤±

**æ ¹æœ¬åŸå› åˆ†æï¼š**

1. **äº‹ä»¶ç›‘å¬å™¨æ³„æ¼ä¸æ±¡æŸ“**

```typescript
// Layout ç»„ä»¶
useEffect(() => {
  const handlerId = riskControlManager.registerHandlers(showCaptcha, hideCaptcha);
  handlerIdRef.current = handlerId;
  
  return () => {
    if (handlerIdRef.current) {
      riskControlManager.unregisterHandlers(handlerIdRef.current);
    }
  };
}, [showCaptcha, hideCaptcha]); // âŒ é—®é¢˜æ ¹æº
```

**é—®é¢˜é“¾è·¯ï¼š**

```
ç¬¬1æ¬¡è¿›å•†è¯¦ï¼š
  Layout mount â†’ registerHandlers(handler1) âœ…
  Layout unmount â†’ unregisterHandlers(handler1) âœ…

ç¬¬2æ¬¡è¿›å•†è¯¦ï¼š
  Layout mount â†’ registerHandlers(handler2) âœ…
  ç”±äº showCaptcha/hideCaptcha é—­åŒ…æ›´æ–°ï¼ŒuseEffect ä¾èµ–å˜åŒ–
  â†’ æ‰§è¡Œ cleanup â†’ unregister(handler2)
  â†’ é‡æ–°æ‰§è¡Œ effect â†’ register(handler3) âš ï¸
  Layout unmount â†’ unregisterHandlers(?) âŒ å¯èƒ½æ³¨é”€é”™è¯¯çš„ handler

ç¬¬3æ¬¡è¿›å•†è¯¦ï¼š
  currentHandlerId æŒ‡å‘å·²åˆ é™¤çš„ handler
  â†’ showCaptcha() è°ƒç”¨ handlers.get(currentHandlerId) è¿”å› undefined
  â†’ éªŒè¯ç æ— æ³•æ˜¾ç¤º
  â†’ è¯·æ±‚æŒ‚èµ·ï¼Œé¡µé¢å¡åœ¨ loading âŒ
```

2. **Promise å¼•ç”¨æ³„æ¼**

```typescript
const promiseRef = useRef<{resolve, reject} | null>(null);

const showCaptcha = useCallback((options?: any): Promise<any> => {
  setShowCaptchaModal(true);
  return new Promise((resolve, reject) => {
    promiseRef.current = { resolve, reject }; // âŒ å¯èƒ½æ³„æ¼
  });
}, []);
```

**æ³„æ¼åœºæ™¯ï¼š**
- ç”¨æˆ·**å¿«é€Ÿå…³é—­éªŒè¯ç å¼¹çª—**æˆ–**å¿«é€Ÿåˆ‡æ¢é¡µé¢**
- `promiseRef.current` æœªè¢«æ¸…ç©ºï¼ˆæ²¡æœ‰è°ƒç”¨ resolve/rejectï¼‰
- æ—§çš„ Promise æ°¸è¿œä¸ä¼š resolve
- ä¸‹æ¬¡è¿›å…¥é¡µé¢åˆ›å»ºæ–° Promiseï¼Œä½†è¯·æ±‚ä»åœ¨ç­‰å¾…æ—§ Promise
- **å¯¼è‡´è¯·æ±‚æ°¸ä¹…æŒ‚èµ·ï¼Œé¡µé¢å¡åœ¨ loading**

3. **handler æ˜ å°„è¡¨æ—¶åºé”™è¯¯**

```typescript
class RiskControlManager {
  private handlers = new Map<string, {show, hide}>();
  private currentHandlerId: string;
  
  registerHandlers(show, hide) {
    const id = generateId();
    this.handlers.set(id, {show, hide}); // âŒ å¯èƒ½æ®‹ç•™
    this.currentHandlerId = id; // âŒ å¯èƒ½è¢«è¦†ç›–
    return id;
  }
}
```

**å¹¶å‘æ³¨å†Œé—®é¢˜ï¼š**
- é¡µé¢ A è¿˜æœªå®Œå…¨å¸è½½æ—¶ï¼Œé¡µé¢ B å·²ç»å¼€å§‹æŒ‚è½½
- ä¸¤ä¸ªé¡µé¢åŒæ—¶è°ƒç”¨ `registerHandlers()`
- `currentHandlerId` è¢«è¦†ç›–ï¼ŒæŒ‡å‘é”™è¯¯çš„é¡µé¢
- åç»­è°ƒç”¨ `showCaptcha()` æ—¶è·¯ç”±åˆ°é”™è¯¯çš„é¡µé¢æˆ–æ‰¾ä¸åˆ° handler

**ä¸ºä»€ä¹ˆæ³¨é‡Šæ‰é£æ§å°±å¥½äº†ï¼Ÿ**
- ä¸å†åˆ›å»º `DxCaptcha` ç»„ä»¶å®ä¾‹
- ä¸å†æ³¨å†Œ/æ³¨é”€ handlersï¼Œé¿å…æ˜ å°„è¡¨æ±¡æŸ“
- ä¸å†æœ‰ Promise å¼•ç”¨æ³„æ¼
- æ­¤æ—¶ GlobalComponent çš„æ–°å®ç°å·²æ¥ç®¡é£æ§åŠŸèƒ½ï¼ˆé€šè¿‡äº‹ä»¶æœºåˆ¶ï¼‰

**çº¿ä¸Šå½±å“ï¼š**
- ç”¨æˆ·ä½“éªŒæå·®ï¼Œé¡µé¢å®Œå…¨æ— æ³•ä½¿ç”¨
- æ¦‚ç‡æ€§å¤ç°ï¼Œéš¾ä»¥å®šä½
- å½±å“æ ¸å¿ƒè´­ç‰©æµç¨‹ï¼ˆå•†è¯¦é¡µæ˜¯è½¬åŒ–å…³é”®é¡µé¢ï¼‰

---

### 2.2 æ–°æ–¹æ¡ˆï¼šäº‹ä»¶å‘å¸ƒè®¢é˜…æ¨¡å¼

#### æ ¸å¿ƒæ€æƒ³

**å°†è°ƒç”¨æ–¹ä¸å®ç°æ–¹è§£è€¦ï¼Œåˆ©ç”¨äº‹ä»¶ä¸­å¿ƒä½œä¸ºä¸­é—´å±‚ï¼Œé€šè¿‡é¡µé¢å”¯ä¸€æ ‡è¯†è‡ªåŠ¨è·¯ç”±äº‹ä»¶åˆ°æ­£ç¡®çš„é¡µé¢ã€‚**

#### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è°ƒç”¨æ–¹ï¼ˆä»»æ„ä½ç½®ï¼‰                         â”‚
â”‚                  RiskControlManager.showCaptcha()            â”‚
â”‚                          Taro.$showCaptcha()                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ å‘å¸ƒäº‹ä»¶
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Taro.eventCenter                          â”‚
â”‚              äº‹ä»¶åï¼šGLOBAL_COMP_EVENT_${pageId}             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ è‡ªåŠ¨è·¯ç”±ï¼ˆåŸºäºé¡µé¢å”¯ä¸€æ ‡è¯†ï¼‰
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å½“å‰é¡µé¢çš„ GlobalComponent                       â”‚
â”‚                    ç›‘å¬å¹¶å¤„ç†äº‹ä»¶                             â”‚
â”‚                   æ˜¾ç¤º DxCaptcha ç»„ä»¶                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€GlobalComponent æ ¸å¿ƒè®¾è®¡åŸç†

### 3.1 å‘å¸ƒ-è®¢é˜…æ¨¡å¼æ·±åº¦è§£æ

#### ä»€ä¹ˆæ˜¯å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼Ÿ

å‘å¸ƒ-è®¢é˜…ï¼ˆPub/Subï¼‰æ˜¯ä¸€ç§æ¶ˆæ¯ä¼ é€’èŒƒå¼ï¼Œ**å‘å¸ƒè€…ï¼ˆPublisherï¼‰ä¸ç›´æ¥å‘ç‰¹å®šçš„è®¢é˜…è€…ï¼ˆSubscriberï¼‰å‘é€æ¶ˆæ¯ï¼Œè€Œæ˜¯é€šè¿‡äº‹ä»¶ä¸­å¿ƒï¼ˆEvent Centerï¼‰ä½œä¸ºä¸­é—´å±‚è¿›è¡Œè§£è€¦**ã€‚

```typescript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‘å¸ƒè€…      â”‚ ----â†’ â”‚   äº‹ä»¶ä¸­å¿ƒ    â”‚ ----â†’ â”‚   è®¢é˜…è€…      â”‚
â”‚  Publisher   â”‚  å‘å¸ƒ  â”‚ Event Center â”‚  æ¨é€  â”‚  Subscriber  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     ä¸çŸ¥é“è®¢é˜…è€…           ç®¡ç†æ‰€æœ‰äº‹ä»¶            ä¸çŸ¥é“å‘å¸ƒè€…
```

**å…³é”®ç‰¹å¾ï¼š**
- **è§£è€¦**ï¼šå‘å¸ƒè€…å’Œè®¢é˜…è€…äº’ä¸æ„ŸçŸ¥å¯¹æ–¹çš„å­˜åœ¨
- **å¤šæ’­**ï¼šä¸€ä¸ªäº‹ä»¶å¯ä»¥æœ‰å¤šä¸ªè®¢é˜…è€…
- **å¼‚æ­¥**ï¼šäº‹ä»¶å‘å¸ƒå’Œå¤„ç†å¯ä»¥æ˜¯å¼‚æ­¥çš„

#### ä¸ºä»€ä¹ˆé€‰æ‹©å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼Ÿ

| å¯¹æ¯”ç»´åº¦ | ä¼ ç»Ÿå›è°ƒæ³¨å†Œ | å‘å¸ƒ-è®¢é˜…æ¨¡å¼ |
|---------|------------|-------------|
| **è€¦åˆåº¦** | é«˜ï¼ˆéœ€è¦æ‰‹åŠ¨æ³¨å†Œ/æ³¨é”€ï¼‰ | ä½ï¼ˆé€šè¿‡äº‹ä»¶ä¸­å¿ƒè§£è€¦ï¼‰ |
| **å¯ç»´æŠ¤æ€§** | éœ€è¦ç»´æŠ¤æ˜ å°„è¡¨ | äº‹ä»¶ä¸­å¿ƒè‡ªåŠ¨ç®¡ç† |
| **æ‰©å±•æ€§** | æ–°å¢è®¢é˜…è€…éœ€ä¿®æ”¹å‘å¸ƒè€… | æ–°å¢è®¢é˜…è€…åªéœ€ç›‘å¬äº‹ä»¶ |
| **ç”Ÿå‘½å‘¨æœŸ** | æ‰‹åŠ¨ç®¡ç†å®¹æ˜“æ³„æ¼ | ç»„ä»¶å¸è½½è‡ªåŠ¨æ¸…ç† |
| **è·¨å±‚çº§é€šä¿¡** | éœ€è¦å±‚å±‚ä¼ é€’å›è°ƒ | ç›´æ¥é€šè¿‡äº‹ä»¶é€šä¿¡ |

---

### 3.2 äº‹ä»¶æ³¨å†Œæœºåˆ¶ï¼šåŸºäºé¡µé¢å”¯ä¸€æ ‡è¯†çš„è·¯ç”±

#### æ ¸å¿ƒåŸç†ï¼šæ¯ä¸ªé¡µé¢æœ‰ç‹¬ç«‹çš„äº‹ä»¶å

```typescript
// é¡µé¢ A çš„äº‹ä»¶å
"GLOBAL_COMP_EVENT_node_12345"
         â†‘            â†‘
      å›ºå®šå‰ç¼€    é¡µé¢å”¯ä¸€æ ‡è¯†

// é¡µé¢ B çš„äº‹ä»¶å
"GLOBAL_COMP_EVENT_node_67890"
         â†‘            â†‘
      å›ºå®šå‰ç¼€    é¡µé¢å”¯ä¸€æ ‡è¯†ï¼ˆä¸åŒï¼‰
```

**å…³é”®å®ç°æ­¥éª¤ï¼š**

**æ­¥éª¤ 1ï¼šè·å–é¡µé¢å”¯ä¸€æ ‡è¯†**

```typescript
// src/components/GlobalComponent/index.tsx

useEffect(() => {
  // 1. è·å–å½“å‰é¡µé¢å®ä¾‹
  const { page } = Taro.getCurrentInstance();
  
  // 2. æå–é¡µé¢å”¯ä¸€æ ‡è¯†
  const path = page?.[EVENT_PATH_KEY];
  // å¾®ä¿¡å°ç¨‹åºï¼š__wxExparserNodeId__ = "exparser-node-id-12345"
  // å…¶ä»–å¹³å°ï¼š$taroPath = "/pages/index/index_1234567890"
  
  if (path) {
    // 3. ç”Ÿæˆè¯¥é¡µé¢ä¸“å±çš„äº‹ä»¶å
    eventName.current = `GLOBAL_COMP_EVENT_${path}`;
    // ç»“æœç¤ºä¾‹ï¼š"GLOBAL_COMP_EVENT_exparser-node-id-12345"
  }
}, []);
```

**æ­¥éª¤ 2ï¼šæ³¨å†Œäº‹ä»¶ç›‘å¬å™¨**

```typescript
// ç»§ç»­ useEffect å†…éƒ¨

// 4. æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
Taro.eventCenter.on(eventName.current, (options = {}) => {
  const { type, config } = options;
  
  // å¤„ç†ä¸åŒç±»å‹çš„äº‹ä»¶
  switch (type) {
    case 'showCaptcha': {
      // æ˜¾ç¤ºéªŒè¯ç é€»è¾‘
      setShowCaptcha(true);
      
      // åˆ›å»º Promise å¹¶è¿”å›ç»™è°ƒç”¨æ–¹
      const promise = new Promise((resolve, reject) => {
        captchaPromiseRef.current = { resolve, reject };
      });
      config?.callback?.(promise);
      break;
    }
    
    case 'hideCaptcha': {
      // éšè—éªŒè¯ç é€»è¾‘
      setShowCaptcha(false);
      break;
    }
  }
});
```

**æ­¥éª¤ 3ï¼šé€šçŸ¥äº‹ä»¶å·²å°±ç»ª**

```typescript
// 5. å¹¿æ’­äº‹ä»¶åˆå§‹åŒ–å®Œæˆä¿¡å·
Taro.eventCenter.trigger(`GLOBAL_COMP_EVENT_INITED_${path}`);
// è¿™ä¸ªä¿¡å·ä¼šè¢« setup.ts ä¸­çš„äº‹ä»¶é˜Ÿåˆ—æœºåˆ¶ç›‘å¬
```

**æ­¥éª¤ 4ï¼šç»„ä»¶å¸è½½æ—¶æ¸…ç†**

```typescript
// 6. è¿”å›æ¸…ç†å‡½æ•°
return () => {
  if (eventName.current) {
    Taro.eventCenter.off(eventName.current);
    // âœ… è‡ªåŠ¨è§£ç»‘ï¼Œä¸ä¼šæœ‰å†…å­˜æ³„æ¼
  }
};
```

#### å®Œæ•´äº‹ä»¶æ³¨å†Œæµç¨‹å›¾

```typescript
é¡µé¢æŒ‚è½½
  â†“
getCurrentInstance() â†’ è·å– page å¯¹è±¡
  â†“
page[EVENT_PATH_KEY] â†’ æå–å”¯ä¸€æ ‡è¯† "node_12345"
  â†“
ç”Ÿæˆäº‹ä»¶å "GLOBAL_COMP_EVENT_node_12345"
  â†“
Taro.eventCenter.on(eventName, handler) â†’ æ³¨å†Œç›‘å¬å™¨
  â†“
Taro.eventCenter.trigger("INITED_node_12345") â†’ é€šçŸ¥å·²å°±ç»ª
  â†“
ç­‰å¾…å¤–éƒ¨è°ƒç”¨...
  â†“
é¡µé¢å¸è½½
  â†“
Taro.eventCenter.off(eventName) â†’ è‡ªåŠ¨æ¸…ç† âœ…
```

---

### 3.3 äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼šè°ƒç”¨æ–¹å¦‚ä½•è§¦å‘äº‹ä»¶

#### å®Œæ•´çš„äº‹ä»¶é€šçŸ¥æµç¨‹

**é˜¶æ®µ 1ï¼šè°ƒç”¨æ–¹å‘èµ·è¯·æ±‚**

```typescript
// ä»»æ„ä½ç½®è°ƒç”¨å…¨å±€æ–¹æ³•
const result = await Taro.$showCaptcha();
```

**é˜¶æ®µ 2ï¼šå…¨å±€æ–¹æ³•è§¦å‘äº‹ä»¶**

```typescript
// src/components/GlobalComponent/setup.ts

Taro.$showCaptcha = (): Promise<RiskControlResult> => {
  return new Promise((resolveA) => {  // â† Promise Aï¼ˆæœ€ç»ˆè¿”å›ç»™è°ƒç”¨æ–¹ï¼‰
    
    // 1. è°ƒç”¨äº‹ä»¶å‘å¸ƒå‡½æ•°
    globalComponentEvent({
      type: 'showCaptcha',
      config: {
        // 2. ä¼ å…¥å›è°ƒï¼Œç”¨äºæ¥æ”¶ GlobalComponent åˆ›å»ºçš„ Promise B
        callback: (promiseB: Promise<any>) => {
          // 3. å°† Promise B çš„ç»“æœä¼ é€’ç»™ Promise A
          promiseB.then(resolveA).catch(resolveA);
        },
      },
    });
  });
};
```

**é˜¶æ®µ 3ï¼šè·å–å½“å‰é¡µé¢æ ‡è¯†å¹¶å‘å¸ƒäº‹ä»¶**

```typescript
// globalComponentEvent å‡½æ•°å†…éƒ¨

const globalComponentEvent = (options) => {
  // 1. è·å–å½“å‰é¡µé¢æ ˆ
  const pages = Taro.getCurrentPages();
  const curPage = pages[pages.length - 1]; // æ ˆé¡¶ = å½“å‰é¡µé¢
  
  // 2. æå–é¡µé¢å”¯ä¸€æ ‡è¯†
  let path = curPage?.[EVENT_PATH_KEY];
  // path = "node_12345"ï¼ˆä¸ GlobalComponent è·å–çš„ä¸€è‡´ï¼ï¼‰
  
  if (path) {
    // 3. ç”Ÿæˆäº‹ä»¶åï¼ˆä¸ç›‘å¬å™¨çš„äº‹ä»¶åå®Œå…¨ç›¸åŒï¼‰
    const eventName = `GLOBAL_COMP_EVENT_${path}`;
    
    // 4. æ£€æŸ¥è¯¥äº‹ä»¶æ˜¯å¦å·²æ³¨å†Œ
    if ((Taro.eventCenter as any).callbacks[eventName]) {
      // å·²æ³¨å†Œ â†’ ç«‹å³å‘å¸ƒäº‹ä»¶
      Taro.eventCenter.trigger(eventName, options);
    } else {
      // æœªæ³¨å†Œ â†’ æ”¾å…¥é˜Ÿåˆ—ï¼Œç­‰å¾… GlobalComponent åˆå§‹åŒ–
      eventQueue.push({ eventName, options });
      
      // ç›‘å¬åˆå§‹åŒ–ä¿¡å·
      Taro.eventCenter.once(`GLOBAL_COMP_EVENT_INITED_${path}`, () => {
        // æ”¶åˆ°ä¿¡å·åï¼Œè§¦å‘é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰äº‹ä»¶
        eventQueue.forEach(item => {
          Taro.eventCenter.trigger(item.eventName, item.options);
        });
        eventQueue = []; // æ¸…ç©ºé˜Ÿåˆ—
      });
    }
  }
};
```

**é˜¶æ®µ 4ï¼šGlobalComponent æ¥æ”¶äº‹ä»¶å¹¶å¤„ç†**

```typescript
// GlobalComponent çš„äº‹ä»¶ç›‘å¬å™¨è¢«è§¦å‘

Taro.eventCenter.on(eventName.current, (options = {}) => {
  const { type, config } = options;
  
  if (type === 'showCaptcha') {
    // 1. æ˜¾ç¤ºéªŒè¯ç  UI
    setShowCaptcha(true);
    
    // 2. åˆ›å»º Promise B
    const promiseB = new Promise((resolveB, rejectB) => {
      // ä¿å­˜ resolve/rejectï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ
      captchaPromiseRef.current = { resolve: resolveB, reject: rejectB };
    });
    
    // 3. é€šè¿‡ callback å°† Promise B è¿”å›ç»™è°ƒç”¨æ–¹
    config?.callback?.(promiseB);
    //              â†‘
    // è¿™ä¸ª callback å°±æ˜¯ setup.ts ä¸­å®šä¹‰çš„å‡½æ•°
    // å®ƒä¼šå°† Promise B çš„ç»“æœä¼ é€’ç»™ Promise A
  }
});
```

**é˜¶æ®µ 5ï¼šç”¨æˆ·å®ŒæˆéªŒè¯å resolve Promise**

```typescript
// ç”¨æˆ·ç‚¹å‡»éªŒè¯ç å®ŒæˆéªŒè¯

const handleCaptchaSuccess = (data: string) => {
  // 1. éšè—éªŒè¯ç 
  setShowCaptcha(false);
  
  // 2. resolve Promise Bï¼ˆè‡ªåŠ¨ä¼ é€’ç»™ Promise Aï¼‰
  captchaPromiseRef.current?.resolve({
    success: true,
    data, // éªŒè¯ token
  });
  
  // 3. æ¸…ç†å¼•ç”¨ï¼Œé˜²æ­¢æ³„æ¼
  captchaPromiseRef.current = null;
};

// ç”¨æˆ·å…³é—­éªŒè¯ç 

const handleCaptchaHide = () => {
  setShowCaptcha(false);
  
  // resolve å¤±è´¥çŠ¶æ€
  captchaPromiseRef.current?.resolve({
    success: false,
    error: 'ç”¨æˆ·å–æ¶ˆéªŒè¯',
  });
  
  captchaPromiseRef.current = null;
};
```

#### å®Œæ•´é€šçŸ¥æµç¨‹æ—¶åºå›¾

```
è°ƒç”¨æ–¹                 setup.ts           eventCenter        GlobalComponent        ç”¨æˆ·
  â”‚                      â”‚                     â”‚                    â”‚                â”‚
  â”‚  await $showCaptcha()â”‚                     â”‚                    â”‚                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                     â”‚                    â”‚                â”‚
  â”‚                      â”‚ new Promise(resolveA)                    â”‚                â”‚
  â”‚                      â”‚                     â”‚                    â”‚                â”‚
  â”‚                      â”‚ globalComponentEvent()                   â”‚                â”‚
  â”‚                      â”‚ getCurrentPages()   â”‚                    â”‚                â”‚
  â”‚                      â”‚ path="node_12345"   â”‚                    â”‚                â”‚
  â”‚                      â”‚                     â”‚                    â”‚                â”‚
  â”‚                      â”‚ trigger(EVENT_node_12345, {type, config})â”‚                â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                    â”‚                â”‚
  â”‚                      â”‚                     â”‚ è·¯ç”±åˆ° node_12345   â”‚                â”‚
  â”‚                      â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                â”‚
  â”‚                      â”‚                     â”‚    handler(options)â”‚                â”‚
  â”‚                      â”‚                     â”‚                    â”‚ setShowCaptcha(true)
  â”‚                      â”‚                     â”‚                    â”‚ æ˜¾ç¤ºéªŒè¯ç  UI  â”‚
  â”‚                      â”‚                     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                      â”‚                     â”‚                    â”‚                â”‚
  â”‚                      â”‚                     â”‚  new Promise(resolveB)              â”‚
  â”‚                      â”‚                     â”‚    captchaPromiseRef.current = {resolveB}
  â”‚                      â”‚                     â”‚                    â”‚                â”‚
  â”‚                      â”‚                     â”‚  config.callback(promiseB)          â”‚
  â”‚                      â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
  â”‚                      â”‚ promiseB.then(resolveA)                  â”‚                â”‚
  â”‚                      â”‚                     â”‚                    â”‚                â”‚
  â”‚  (ç­‰å¾… Promise A)     â”‚  (ç­‰å¾… Promise B)   â”‚                    â”‚  (ç­‰å¾…ç”¨æˆ·æ“ä½œ)  â”‚
  â”‚                      â”‚                     â”‚                    â”‚                â”‚
  â”‚                      â”‚                     â”‚                    â”‚   ç”¨æˆ·ç‚¹å‡»éªŒè¯  â”‚
  â”‚                      â”‚                     â”‚                    â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚                     â”‚                    â”‚ onSuccess(data)â”‚
  â”‚                      â”‚                     â”‚                    â”‚ resolveB({success:true, data})
  â”‚                      â”‚                     â”‚                    â”‚                â”‚
  â”‚                      â”‚ resolveA è¢«è§¦å‘(é€šè¿‡ promiseB.then)       â”‚                â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                    â”‚                â”‚
  â”‚ result={success:true}â”‚                     â”‚                    â”‚                â”‚
  â”‚                      â”‚                     â”‚                    â”‚                â”‚
```

---

### 3.4 äº‹ä»¶é˜Ÿåˆ—æœºåˆ¶ï¼šè§£å†³æ—¶åºé—®é¢˜

#### ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶é˜Ÿåˆ—ï¼Ÿ

**é—®é¢˜åœºæ™¯ï¼š**
```typescript
// é¡µé¢åˆšå¼€å§‹åŠ è½½æ—¶ï¼Œå¯èƒ½å‡ºç°ç«æ€æ¡ä»¶

æ—¶åˆ» T1ï¼šè¯·æ±‚æ‹¦æˆªå™¨è§¦å‘ â†’ Taro.$showCaptcha() å‘å¸ƒäº‹ä»¶
æ—¶åˆ» T2ï¼šGlobalComponent æŒ‚è½½ â†’ æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨

// å¦‚æœ T1 < T2ï¼Œäº‹ä»¶åœ¨ç›‘å¬å™¨æ³¨å†Œä¹‹å‰å°±å‘å¸ƒäº† â†’ äº‹ä»¶ä¸¢å¤± âŒ
```

**è§£å†³æ–¹æ¡ˆï¼šäº‹ä»¶é˜Ÿåˆ— + åˆå§‹åŒ–ä¿¡å·**

```typescript
// setup.ts

let eventQueue = []; // äº‹ä»¶é˜Ÿåˆ—

const globalComponentEvent = (options) => {
  const eventName = `GLOBAL_COMP_EVENT_${path}`;
  
  // æ£€æŸ¥äº‹ä»¶æ˜¯å¦å·²æ³¨å†Œ
  if ((Taro.eventCenter as any).callbacks[eventName]) {
    // âœ… å·²æ³¨å†Œï¼Œç›´æ¥å‘å¸ƒ
    Taro.eventCenter.trigger(eventName, options);
  } else {
    // âš ï¸ æœªæ³¨å†Œï¼Œæ”¾å…¥é˜Ÿåˆ—
    console.log('[äº‹ä»¶é˜Ÿåˆ—] ç›‘å¬å™¨æœªå°±ç»ªï¼ŒåŠ å…¥é˜Ÿåˆ—');
    eventQueue.push({ eventName, options });
    
    // ç›‘å¬åˆå§‹åŒ–ä¿¡å·ï¼ˆåªç›‘å¬ä¸€æ¬¡ï¼‰
    const initedEventName = `GLOBAL_COMP_EVENT_INITED_${path}`;
    Taro.eventCenter.once(initedEventName, () => {
      console.log('[äº‹ä»¶é˜Ÿåˆ—] æ”¶åˆ°åˆå§‹åŒ–ä¿¡å·ï¼Œå¤„ç†é˜Ÿåˆ—');
      
      // æ‰¹é‡è§¦å‘é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰äº‹ä»¶
      eventQueue.forEach(item => {
        if (item.eventName === eventName) {
          Taro.eventCenter.trigger(item.eventName, item.options);
        }
      });
      
      // æ¸…ç©ºå·²å¤„ç†çš„äº‹ä»¶
      eventQueue = eventQueue.filter(item => item.eventName !== eventName);
    });
  }
};
```

**æ—¶åºå›¾ï¼š**

```
è¯·æ±‚æ‹¦æˆªå™¨          setup.ts          eventQueue        GlobalComponent
  â”‚                  â”‚                    â”‚                    â”‚
  â”‚ $showCaptcha()   â”‚                    â”‚                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                    â”‚                    â”‚
  â”‚                  â”‚ æ£€æŸ¥ç›‘å¬å™¨æ˜¯å¦æ³¨å†Œ  â”‚                    â”‚
  â”‚                  â”‚ â†’ æœªæ³¨å†Œ âš ï¸        â”‚                    â”‚
  â”‚                  â”‚                    â”‚                    â”‚
  â”‚                  â”‚ push({eventName, options})              â”‚
  â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                    â”‚
  â”‚                  â”‚                    â”‚ [{event1}]         â”‚
  â”‚                  â”‚                    â”‚                    â”‚
  â”‚                  â”‚ on("INITED_xxx")   â”‚                    â”‚
  â”‚                  â”‚ (ç­‰å¾…åˆå§‹åŒ–ä¿¡å·)     â”‚                    â”‚
  â”‚                  â”‚                    â”‚                    â”‚
  â”‚                  â”‚                    â”‚      æŒ‚è½½ + æ³¨å†Œç›‘å¬å™¨
  â”‚                  â”‚                    â”‚                    â”‚
  â”‚                  â”‚                    â”‚   trigger("INITED_xxx")
  â”‚                  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                  â”‚ æ”¶åˆ°ä¿¡å·ï¼          â”‚                    â”‚
  â”‚                  â”‚                    â”‚                    â”‚
  â”‚                  â”‚ forEach(queue.trigger)                  â”‚
  â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                  â”‚                    â”‚      handler(event1) âœ…
  â”‚                  â”‚                    â”‚                    â”‚
```

---

### 3.5 åŒå‘ Promise ä¼ é€’é“¾è·¯

è¿™æ˜¯æ•´ä¸ªè®¾è®¡ä¸­æœ€ç²¾å¦™çš„éƒ¨åˆ†ï¼Œé€šè¿‡**ä¸¤ä¸ª Promise çš„é“¾å¼ä¼ é€’**å®ç°å¼‚æ­¥ç»“æœè¿”å›ã€‚

#### Promise A å’Œ Promise B çš„è§’è‰²

```typescript
Promise Aï¼šè°ƒç”¨æ–¹æŒæœ‰çš„ Promiseï¼ˆåœ¨ setup.ts ä¸­åˆ›å»ºï¼‰
  â†“
  ä½œç”¨ï¼šæä¾›ç»™è°ƒç”¨æ–¹ awaitï¼Œè¿”å›æœ€ç»ˆéªŒè¯ç»“æœ
  ç”Ÿå‘½å‘¨æœŸï¼šä»è°ƒç”¨ $showCaptcha() åˆ°ç”¨æˆ·å®ŒæˆéªŒè¯

Promise Bï¼šGlobalComponent åˆ›å»ºçš„ Promise
  â†“
  ä½œç”¨ï¼šç­‰å¾…ç”¨æˆ·æ“ä½œï¼Œresolve/reject ç”±ç”¨æˆ·è¡Œä¸ºè§¦å‘
  ç”Ÿå‘½å‘¨æœŸï¼šä»æ˜¾ç¤ºéªŒè¯ç åˆ°ç”¨æˆ·ç‚¹å‡»å®Œæˆ/å…³é—­

å…³é”®æ¡¥æ¢ï¼šconfig.callback å‡½æ•°
  â†“
  å°† Promise B çš„ç»“æœä¼ é€’ç»™ Promise A
  å®ç°ä»£ç ï¼špromiseB.then(resolveA).catch(resolveA)
```

#### å®Œæ•´ä»£ç é“¾è·¯

```typescript
// ==================== æ­¥éª¤ 1ï¼šè°ƒç”¨æ–¹ ====================
const result = await Taro.$showCaptcha();
//              â†‘ ç­‰å¾… Promise A resolve


// ==================== æ­¥éª¤ 2ï¼šsetup.ts ====================
Taro.$showCaptcha = () => {
  return new Promise((resolveA) => {  // â† Promise A
    globalComponentEvent({
      type: 'showCaptcha',
      config: {
        callback: (promiseB) => {  // â† æ¥æ”¶ Promise B
          // å…³é”®ï¼å°† B çš„ç»“æœä¼ ç»™ A
          promiseB.then(resolveA).catch(resolveA);
        },
      },
    });
  });
};


// ==================== æ­¥éª¤ 3ï¼šGlobalComponent ====================
Taro.eventCenter.on(eventName.current, (options) => {
  const { type, config } = options;
  
  if (type === 'showCaptcha') {
    const promiseB = new Promise((resolveB, rejectB) => {  // â† Promise B
      captchaPromiseRef.current = { resolve: resolveB, reject: rejectB };
    });
    
    // é€šè¿‡ callback è¿”å› Promise B
    config?.callback?.(promiseB);  // â† è§¦å‘ promiseB.then(resolveA)
  }
});


// ==================== æ­¥éª¤ 4ï¼šç”¨æˆ·æ“ä½œ ====================
const handleCaptchaSuccess = (data: string) => {
  // resolve Promise B
  captchaPromiseRef.current?.resolve({ success: true, data });
  //                                   â†“
  //                    Promise B resolve
  //                                   â†“
  //               promiseB.then(resolveA) è¢«è§¦å‘
  //                                   â†“
  //                    Promise A resolve
  //                                   â†“
  //                è°ƒç”¨æ–¹çš„ await å¾—åˆ°ç»“æœ âœ…
};
```

#### æ•°æ®æµå‘å›¾

```
è°ƒç”¨æ–¹              Promise A              callback              Promise B              ç”¨æˆ·æ“ä½œ
  â”‚                    â”‚                      â”‚                     â”‚                      â”‚
  â”‚ await              â”‚                      â”‚                     â”‚                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ new Promise(resolveA)â”‚                     â”‚                      â”‚
  â”‚                    â”‚                      â”‚                     â”‚                      â”‚
  â”‚                    â”‚                      â”‚ callback(promiseB)  â”‚                      â”‚
  â”‚                    â”‚                      â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ new Promise(resolveB)â”‚
  â”‚                    â”‚                      â”‚                     â”‚                      â”‚
  â”‚                    â”‚                      â”‚ promiseB.then(resolveA)                    â”‚
  â”‚                    â”‚                      â”‚ (å»ºç«‹ B â†’ A çš„è¿æ¥)  â”‚                      â”‚
  â”‚                    â”‚                      â”‚                     â”‚                      â”‚
  â”‚   (ç­‰å¾…ä¸­...)       â”‚   (ç­‰å¾…ä¸­...)         â”‚                     â”‚   (ç­‰å¾…ä¸­...)         â”‚
  â”‚                    â”‚                      â”‚                     â”‚                      â”‚
  â”‚                    â”‚                      â”‚                     â”‚    ç”¨æˆ·ç‚¹å‡»éªŒè¯       â”‚
  â”‚                    â”‚                      â”‚                     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                    â”‚                      â”‚                     â”‚ resolveB({data})     â”‚
  â”‚                    â”‚                      â”‚                     â”‚      â†“               â”‚
  â”‚                    â”‚                      â”‚    Promise B resolveâ”‚                      â”‚
  â”‚                    â”‚                      â”‚           â†“         â”‚                      â”‚
  â”‚                    â”‚                      â”‚  then(resolveA) è§¦å‘ â”‚                      â”‚
  â”‚                    â”‚                      â”‚           â†“         â”‚                      â”‚
  â”‚                    â”‚     Promise A resolveâ”‚                     â”‚                      â”‚
  â”‚                    â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚                      â”‚
  â”‚   å¾—åˆ° result      â”‚                      â”‚                     â”‚                      â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚                     â”‚                      â”‚
```

---

## å››ã€æ ¸å¿ƒå®ç°è¯¦è§£

### 4.1 å…¨å±€æ–¹æ³•å®šä¹‰ï¼ˆsetup.tsï¼‰

```typescript
// src/components/GlobalComponent/setup.ts

// è·å–é¡µé¢å”¯ä¸€æ ‡è¯†çš„ key
export const EVENT_PATH_KEY =
  process.env.TARO_ENV === 'weapp' ? '__wxExparserNodeId__' : '$taroPath';

// äº‹ä»¶å‘å¸ƒå‡½æ•°
const globalComponentEvent = (options) => {
  // 1. è·å–å½“å‰é¡µé¢
  const pages = Taro.getCurrentPages();
  const curPage = pages[pages.length - 1];
  
  // 2. æå–é¡µé¢å”¯ä¸€æ ‡è¯†
  let path = curPage?.[EVENT_PATH_KEY];
  if (options?.ctx) {
    path = options.ctx[EVENT_PATH_KEY];
  }
  
  if (path) {
    // 3. ç”Ÿæˆäº‹ä»¶åï¼ˆå¸¦é¡µé¢æ ‡è¯†ï¼‰
    const eventName = `GLOBAL_COMP_EVENT_${path}`;
    
    // 4. å‘å¸ƒäº‹ä»¶
    if ((Taro.eventCenter as any).callbacks[eventName]) {
      Taro.eventCenter.trigger(eventName, options);
    } else {
      // é˜²æ­¢é¡µé¢äº‹ä»¶æœªç»‘å®šï¼Œå…ˆæ”¾å…¥é˜Ÿåˆ—
      eventQueue.push({ eventName, options });
      // ... é˜Ÿåˆ—å¤„ç†é€»è¾‘
    }
  }
};

/**
 * å…¨å±€æ–¹æ³•ï¼šæ˜¾ç¤ºé£æ§éªŒè¯ç 
 * @returns Promise<{success: boolean, data?: string, error?: string}>
 */
Taro.$showCaptcha = (): Promise<RiskControlResult> => {
  return new Promise((resolve) => {
    globalComponentEvent({
      type: 'showCaptcha',
      config: {
        callback: (promise: Promise<any>) => {
          promise.then(resolve).catch(resolve);
        },
      },
    });
  });
};

/**
 * å…¨å±€æ–¹æ³•ï¼šéšè—é£æ§éªŒè¯ç 
 */
Taro.$hideCaptcha = () => {
  globalComponentEvent({
    type: 'hideCaptcha',
  });
};
```

**å…³é”®ç‚¹ï¼š**
1. åˆ©ç”¨ `Taro.getCurrentPages()` è·å–å½“å‰é¡µé¢æ ˆ
2. é€šè¿‡ `__wxExparserNodeId__`ï¼ˆå¾®ä¿¡å°ç¨‹åºï¼‰æˆ– `$taroPath`ï¼ˆå…¶ä»–å¹³å°ï¼‰è·å–é¡µé¢å”¯ä¸€æ ‡è¯†
3. å°†é¡µé¢æ ‡è¯†åµŒå…¥äº‹ä»¶åï¼Œå®ç°è‡ªåŠ¨è·¯ç”±
4. è¿”å› Promiseï¼Œæ”¯æŒå¼‚æ­¥ç­‰å¾…éªŒè¯ç»“æœ

---

### 3.2 GlobalComponent ç»„ä»¶ï¼ˆäº‹ä»¶ç›‘å¬ï¼‰

```typescript
// src/components/GlobalComponent/index.tsx

const GlobalComponent = () => {
  // é£æ§ç›¸å…³çŠ¶æ€
  const captchaRef = useRef<DxCaptchaRef>(null);
  const [showCaptcha, setShowCaptcha] = useState(false);
  const captchaPromiseRef = useRef<{
    resolve: (value: any) => void;
    reject: (reason?: any) => void;
  } | null>(null);
  
  const eventName = useRef('');

  useEffect(() => {
    // 1. è·å–å½“å‰é¡µé¢å®ä¾‹
    const { page } = Taro.getCurrentInstance();
    const path = page?.[EVENT_PATH_KEY];
    
    if (path) {
      // 2. ç”Ÿæˆäº‹ä»¶åï¼ˆä¸ setup.ts ä¸­é€»è¾‘ä¸€è‡´ï¼‰
      eventName.current = `GLOBAL_COMP_EVENT_${path}`;
      
      // 3. ç›‘å¬äº‹ä»¶
      Taro.eventCenter.on(eventName.current, (options = {}) => {
        const { type, config } = options;
        
        switch (type) {
          case 'showCaptcha': {
            setShowCaptcha(true);
            
            // åˆ›å»º Promise ä¾›è°ƒç”¨æ–¹ç­‰å¾…
            const promise = new Promise((resolve, reject) => {
              captchaPromiseRef.current = { resolve, reject };
            });
            
            // é€šè¿‡å›è°ƒè¿”å› promise
            config?.callback?.(promise);
            break;
          }
          
          case 'hideCaptcha': {
            setShowCaptcha(false);
            captchaRef.current?.hideCaptcha();
            break;
          }
        }
      });
      
      // é€šçŸ¥äº‹ä»¶å·²åˆå§‹åŒ–
      Taro.eventCenter.trigger(`GLOBAL_COMP_EVENT_INITED_${path}`);
    }
    
    // 4. å¸è½½æ—¶è§£ç»‘äº‹ä»¶
    return () => {
      if (eventName.current) {
        Taro.eventCenter.off(eventName.current);
      }
    };
  }, []);  // âœ… åªåœ¨æŒ‚è½½/å¸è½½æ—¶æ‰§è¡Œä¸€æ¬¡

  // éªŒè¯æˆåŠŸå›è°ƒ
  const handleCaptchaSuccess = (data: string) => {
    setShowCaptcha(false);
    captchaPromiseRef.current?.resolve({
      success: true,
      data,
    });
    captchaPromiseRef.current = null;
  };

  // éªŒè¯å…³é—­å›è°ƒ
  const handleCaptchaHide = () => {
    setShowCaptcha(false);
    captchaPromiseRef.current?.resolve({
      success: false,
      error: 'ç”¨æˆ·å–æ¶ˆéªŒè¯',
    });
    captchaPromiseRef.current = null;
  };

  return (
    <>
      {/* å…¶ä»–å…¨å±€ç»„ä»¶ */}
      
      {/* é£æ§éªŒè¯ç»„ä»¶ */}
      <DxCaptcha
        ref={captchaRef}
        show={showCaptcha}
        onSuccess={handleCaptchaSuccess}
        onHide={handleCaptchaHide}
      />
    </>
  );
};
```

**å…³é”®ç‚¹ï¼š**
1. ä½¿ç”¨ `useEffect([])` ç¡®ä¿åªåœ¨æŒ‚è½½æ—¶æ³¨å†Œäº‹ä»¶ï¼Œé¿å…é‡å¤æ³¨å†Œ
2. é€šè¿‡ `captchaPromiseRef` ä¿å­˜ Promise çš„ resolve/reject æ–¹æ³•
3. éªŒè¯æˆåŠŸ/å¤±è´¥æ—¶è°ƒç”¨ resolveï¼Œè¿”å›ç»“æœç»™è°ƒç”¨æ–¹
4. ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨è§£ç»‘äº‹ä»¶

---

### 3.3 RiskControlManagerï¼ˆè°ƒç”¨æ–¹ï¼‰

```typescript
// src/services/riskControl/RiskControlManager.ts

export class RiskControlManager {
  private static instance: RiskControlManager;
  private isVerifying: boolean = false;
  private currentVerifyPromise: Promise<RiskControlResult> | null = null;
  private readonly VERIFY_TIMEOUT = 60000; // 60ç§’

  /**
   * æ˜¾ç¤ºéªŒè¯ç 
   */
  public async showCaptcha(
    options?: RiskControlVerifyOptions,
  ): Promise<RiskControlResult> {
    // æ£€æŸ¥å…¨å±€æ–¹æ³•æ˜¯å¦å¯ç”¨
    if (typeof Taro.$showCaptcha !== 'function') {
      console.error('[RiskControlManager] Taro.$showCaptcha æœªå®šä¹‰');
      return { success: false, error: 'é£æ§ç³»ç»Ÿæœªåˆå§‹åŒ–' };
    }

    // é˜²æ­¢å¹¶å‘ï¼šå¦‚æœæ­£åœ¨éªŒè¯ä¸­ï¼Œå¤ç”¨å½“å‰çš„éªŒè¯ Promise
    if (this.isVerifying && this.currentVerifyPromise) {
      console.log('[RiskControlManager] æ£€æµ‹åˆ°å¹¶å‘éªŒè¯è¯·æ±‚ï¼Œå¤ç”¨å½“å‰éªŒè¯');
      return this.currentVerifyPromise;
    }

    this.isVerifying = true;

    try {
      const verifyPromise = this.createVerifyPromise(options);
      this.currentVerifyPromise = verifyPromise;
      const result = await verifyPromise;
      return result;
    } catch (error) {
      console.error('[RiskControlManager] éªŒè¯è¿‡ç¨‹å‘ç”Ÿé”™è¯¯:', error);
      return {
        success: false,
        error: error instanceof Error ? error.message : 'éªŒè¯è¿‡ç¨‹å‘ç”ŸæœªçŸ¥é”™è¯¯',
      };
    } finally {
      this.isVerifying = false;
      this.currentVerifyPromise = null;
    }
  }

  /**
   * åˆ›å»ºå¸¦è¶…æ—¶æ§åˆ¶çš„éªŒè¯ Promise
   */
  private createVerifyPromise(
    options?: RiskControlVerifyOptions,
  ): Promise<RiskControlResult> {
    // è¶…æ—¶ Promise
    const timeoutPromise = new Promise<RiskControlResult>((_, reject) => {
      setTimeout(() => {
        reject(new Error('éªŒè¯è¶…æ—¶ï¼Œè¯·é‡è¯•'));
      }, this.VERIFY_TIMEOUT);
    });

    // è°ƒç”¨å…¨å±€æ–¹æ³•
    const verifyPromise = Taro.$showCaptcha();

    // ç«æ€ï¼šå…ˆå®Œæˆçš„èƒœå‡º
    return Promise.race([verifyPromise, timeoutPromise]);
  }
}

export const riskControlManager = RiskControlManager.getInstance();
```

**å…³é”®ç‚¹ï¼š**
1. ç›´æ¥è°ƒç”¨ `Taro.$showCaptcha()` å…¨å±€æ–¹æ³•ï¼Œæ— éœ€æ³¨å†Œ
2. å®ç°å¹¶å‘æ§åˆ¶ï¼Œå¤šä¸ªè¯·æ±‚å¤ç”¨åŒä¸€ä¸ªéªŒè¯ Promise
3. æ·»åŠ è¶…æ—¶æœºåˆ¶ï¼Œé˜²æ­¢ç”¨æˆ·é•¿æ—¶é—´ä¸æ“ä½œ
4. å•ä¾‹æ¨¡å¼ï¼Œå…¨å±€å…±äº«ä¸€ä¸ªå®ä¾‹

---

## å››ã€æ ¸å¿ƒæŠ€æœ¯ç‚¹æ·±åº¦è§£æ

### 4.1 é¡µé¢å”¯ä¸€æ ‡è¯†æœºåˆ¶

#### å¾®ä¿¡å°ç¨‹åºï¼š`__wxExparserNodeId__`

**Exparser** æ˜¯å¾®ä¿¡å°ç¨‹åºçš„ç»„ä»¶ç³»ç»Ÿåº•å±‚æ¡†æ¶ï¼Œè´Ÿè´£ç»„ä»¶çš„æ¸²æŸ“ã€æ›´æ–°ã€äº‹ä»¶å¤„ç†ã€‚æ¯ä¸ªç»„ä»¶/é¡µé¢èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªç”±æ¡†æ¶è‡ªåŠ¨ç”Ÿæˆçš„å”¯ä¸€ NodeIdã€‚

```javascript
// å¾®ä¿¡å°ç¨‹åºåº•å±‚æ¶æ„
å°ç¨‹åºé¡µé¢å®ä¾‹
  â†“
WXWebAssembly è™šæ‹Ÿ DOM èŠ‚ç‚¹ï¼ˆExparser æ¡†æ¶ï¼‰
  â†“
æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å”¯ä¸€çš„ __wxExparserNodeId__
```

**ç‰¹æ€§ï¼š**
- âœ… **å…¨å±€å”¯ä¸€**ï¼šæ•´ä¸ªå°ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œæ²¡æœ‰ä¸¤ä¸ªé¡µé¢çš„ ID ç›¸åŒ
- âœ… **è‡ªåŠ¨ç”Ÿæˆ**ï¼šä¸éœ€è¦å¼€å‘è€…æ‰‹åŠ¨åˆ›å»ºæˆ–ç»´æŠ¤
- âœ… **ç¨³å®šä¸å˜**ï¼šé¡µé¢å®ä¾‹å­˜åœ¨æœŸé—´ï¼ŒID ä¸ä¼šå˜åŒ–
- âœ… **å‡†ç¡®æ ‡è¯†**ï¼šå³ä½¿ç›¸åŒè·¯å¾„çš„é¡µé¢åœ¨é¡µé¢æ ˆä¸­æœ‰å¤šä¸ªå®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹çš„ ID ä¹Ÿä¸åŒ

#### å…¶ä»–å¹³å°ï¼šTaro çš„ `$taroPath`

Taro ä¸ºäº†è·¨å¹³å°å…¼å®¹ï¼Œåœ¨å…¶ä»–å¹³å°ï¼ˆæ”¯ä»˜å®ã€æŠ–éŸ³ã€H5ï¼‰ä¸Šæä¾›äº† `$taroPath` ä½œä¸ºé¡µé¢å”¯ä¸€æ ‡è¯†ï¼š

```typescript
// Taro å†…éƒ¨å®ç°ï¼ˆä¼ªä»£ç ï¼‰
class TaroPage {
  constructor(route, params) {
    // ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼šè·¯å¾„ + æ—¶é—´æˆ³ + éšæœºæ•°
    this.$taroPath = `${route}_${params.$taroTimestamp}_${Math.random()}`;
  }
}
```

---

### 4.2 äº‹ä»¶è‡ªåŠ¨è·¯ç”±åŸç†

#### ä¸ºä»€ä¹ˆèƒ½è‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®é¡µé¢ï¼Ÿ

**å…³é”®ï¼šç›‘å¬å’Œè§¦å‘ä½¿ç”¨ç›¸åŒçš„é€»è¾‘ç”Ÿæˆäº‹ä»¶åã€‚**

```typescript
// åœºæ™¯ï¼šç”¨æˆ·åœ¨é¡µé¢ A è§¦å‘éªŒè¯ç 

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1ï¼šé¡µé¢ A çš„ GlobalComponent æŒ‚è½½                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Taro.getCurrentInstance().page[EVENT_PATH_KEY]
    â†“
  path = "__wxExparserNodeId__:abc123"  â† é¡µé¢ A çš„å”¯ä¸€æ ‡è¯†
    â†“
  eventName = "GLOBAL_COMP_EVENT___wxExparserNodeId__:abc123"
    â†“
  Taro.eventCenter.on(eventName, handleEvent)  â† é¡µé¢ A å¼€å§‹ç›‘å¬


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2ï¼šåœ¨é¡µé¢ A è°ƒç”¨ Taro.$showCaptcha()            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  globalComponentEvent({ type: 'showCaptcha' })
    â†“
  Taro.getCurrentPages()[pages.length - 1]  â† è·å–å½“å‰é¡µé¢ï¼ˆæ ˆé¡¶ï¼‰
    â†“
  curPage[EVENT_PATH_KEY] = "__wxExparserNodeId__:abc123"  â† é¡µé¢ A
    â†“
  eventName = "GLOBAL_COMP_EVENT___wxExparserNodeId__:abc123"
    â†“
  Taro.eventCenter.trigger(eventName, options)
    â†“
  âœ… é¡µé¢ A çš„ GlobalComponent æ”¶åˆ°äº‹ä»¶ï¼ˆç›‘å¬çš„æ˜¯åŒä¸€ä¸ªäº‹ä»¶åï¼‰
```

#### å¤šé¡µé¢åœºæ™¯

```typescript
// é¡µé¢æ ˆï¼š[é¦–é¡µ(node_000), åˆ—è¡¨A(node_001), è¯¦æƒ…B(node_002)]

é¡µé¢ A ç›‘å¬: "GLOBAL_COMP_EVENT_node_001"
é¡µé¢ B ç›‘å¬: "GLOBAL_COMP_EVENT_node_002"

// å½“å‰åœ¨é¡µé¢ Bï¼Œè°ƒç”¨ Taro.$showCaptcha()
getCurrentPages()[pages.length - 1]  // è·å– node_002
è§¦å‘äº‹ä»¶: "GLOBAL_COMP_EVENT_node_002"
  â†“
åªæœ‰é¡µé¢ B çš„ GlobalComponent æ”¶åˆ°äº‹ä»¶ âœ…
é¡µé¢ A çš„ GlobalComponent æ”¶ä¸åˆ°ï¼ˆäº‹ä»¶åä¸åŒï¼‰âŒ
```

---

### 4.3 Promise å¼‚æ­¥å¤„ç†é“¾è·¯

```typescript
è°ƒç”¨æ–¹
  â†“
await Taro.$showCaptcha()
  â†“
è¿”å› Promise A (åœ¨ setup.ts ä¸­åˆ›å»º)
  â†“
å‘å¸ƒäº‹ä»¶ï¼Œæºå¸¦ callback
  â†“
GlobalComponent æ”¶åˆ°äº‹ä»¶
  â†“
åˆ›å»º Promise Bï¼Œresolve/reject å­˜å…¥ captchaPromiseRef
  â†“
é€šè¿‡ callback å°† Promise B è¿”å›ç»™ Promise A
  â†“
ç”¨æˆ·å®ŒæˆéªŒè¯
  â†“
onSuccess è§¦å‘ï¼Œè°ƒç”¨ captchaPromiseRef.current.resolve({success: true, data})
  â†“
Promise B resolve
  â†“
Promise A resolveï¼ˆé€šè¿‡ promise.then(resolve)ï¼‰
  â†“
è°ƒç”¨æ–¹çš„ await å¾—åˆ°ç»“æœ âœ…
```

**ç¤ºä¾‹ä»£ç æµç¨‹ï¼š**

```typescript
// 1. è°ƒç”¨æ–¹
const result = await Taro.$showCaptcha();
console.log(result); // { success: true, data: 'xxx' }

// 2. setup.ts
Taro.$showCaptcha = () => {
  return new Promise((resolveA) => {  // Promise A
    globalComponentEvent({
      config: {
        callback: (promiseB) => {
          promiseB.then(resolveA).catch(resolveA);  // B â†’ A
        },
      },
    });
  });
};

// 3. GlobalComponent
const promise = new Promise((resolveB, rejectB) => {  // Promise B
  captchaPromiseRef.current = { resolve: resolveB, reject: rejectB };
});
config?.callback?.(promise);  // ä¼ é€’ Promise B

// 4. ç”¨æˆ·éªŒè¯æˆåŠŸ
const handleCaptchaSuccess = (data: string) => {
  captchaPromiseRef.current?.resolve({  // Promise B resolve
    success: true,
    data,
  });
};
```

---

## äº”ã€æ–°æ—§æ–¹æ¡ˆå¯¹æ¯”

### 5.1 åŠŸèƒ½å¯¹æ¯”è¡¨

| ç»´åº¦ | æ—§æ–¹æ¡ˆï¼ˆLayout æ³¨å†Œï¼‰ | æ–°æ–¹æ¡ˆï¼ˆGlobalComponent äº‹ä»¶ï¼‰ |
|------|---------------------|------------------------------|
| **è°ƒç”¨æ–¹å¼** | `riskControlManager.showCaptcha()` éœ€æ³¨å†Œ | `Taro.$showCaptcha()` å…¨å±€æ–¹æ³• |
| **ç”Ÿå‘½å‘¨æœŸ** | æ‰‹åŠ¨ register/unregister | è‡ªåŠ¨ on/offï¼ˆè·Ÿéšç»„ä»¶ï¼‰ |
| **ä¾èµ–æ›´æ–°** | `useEffect([show, hide])` å¯èƒ½é¢‘ç¹è§¦å‘ | `useEffect([])` åªè§¦å‘ä¸€æ¬¡ |
| **æ‰¾åˆ°ç›®æ ‡é¡µé¢** | é€šè¿‡ handlerId æ˜ å°„ | é€šè¿‡é¡µé¢ path è‡ªåŠ¨è·¯ç”± |
| **ç»´æŠ¤æ˜ å°„è¡¨** | âœ… éœ€è¦ `Map<id, handlers>` | âŒ ä¸éœ€è¦ |
| **ä»£ç å¤æ‚åº¦** | é«˜ï¼ˆæ³¨å†Œæœºåˆ¶ + å›è°ƒç®¡ç†ï¼‰ | ä½ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ |
| **Promise å¤„ç†** | é—´æ¥ï¼ˆé€šè¿‡ callbacksRefï¼‰ | ç›´æ¥è¿”å› Promise |
| **å¹¶å‘å®‰å…¨** | éœ€è¦æ‰‹åŠ¨å¤„ç† | RiskControlManager å±‚ç»Ÿä¸€å¤„ç† |
| **å¤šå®ä¾‹** | æ¯é¡µé¢ä¸€ä¸ªï¼ˆæ— ç»Ÿä¸€ç®¡ç†ï¼‰ | æ¯é¡µé¢ä¸€ä¸ªï¼ˆäº‹ä»¶ç»Ÿä¸€ç®¡ç†ï¼‰ |

### 5.2 ä»£ç é‡å¯¹æ¯”

```typescript
// æ—§æ–¹æ¡ˆï¼šçº¦ 80 è¡Œ
- Layout: 50 è¡Œï¼ˆçŠ¶æ€ç®¡ç† + æ³¨å†Œé€»è¾‘ + å›è°ƒå¤„ç†ï¼‰
- RiskControlManager: 30 è¡Œï¼ˆMap ç®¡ç† + register/unregisterï¼‰

// æ–°æ–¹æ¡ˆï¼šçº¦ 50 è¡Œ
- setup.ts: 20 è¡Œï¼ˆå…¨å±€æ–¹æ³•å®šä¹‰ + äº‹ä»¶å‘å¸ƒï¼‰
- GlobalComponent: 30 è¡Œï¼ˆäº‹ä»¶ç›‘å¬ + Promise å¤„ç†ï¼‰
- RiskControlManager: 10 è¡Œï¼ˆç›´æ¥è°ƒç”¨å…¨å±€æ–¹æ³•ï¼‰

ä»£ç é‡å‡å°‘çº¦ 37.5%
```

---

## å…­ã€ä½¿ç”¨æŒ‡å—

### 6.1 åœ¨è¯·æ±‚æ‹¦æˆªå™¨ä¸­ä½¿ç”¨

```typescript
// src/utils/request.ts
import Taro from '@tarojs/taro';
import { riskControlManager } from '@/services/riskControl/RiskControlManager';

Taro.addInterceptor({
  async request(chain) {
    const { requestParams } = chain;
    
    try {
      const res = await chain.proceed(requestParams);
      
      // æ£€æŸ¥é£æ§æ ‡è¯†
      if (res.data?.riskControl) {
        // è§¦å‘éªŒè¯ç 
        const result = await riskControlManager.showCaptcha();
        
        if (result.success) {
          // éªŒè¯æˆåŠŸï¼Œé‡æ–°å‘èµ·è¯·æ±‚
          requestParams.headers['X-Risk-Token'] = result.data;
          return chain.proceed(requestParams);
        } else {
          // éªŒè¯å¤±è´¥
          throw new Error(result.error || 'éªŒè¯å¤±è´¥');
        }
      }
      
      return res;
    } catch (error) {
      throw error;
    }
  },
});
```

### 6.2 åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```typescript
import Taro from '@tarojs/taro';

const MyComponent = () => {
  const handleSubmit = async () => {
    // ç›´æ¥è°ƒç”¨å…¨å±€æ–¹æ³•
    const result = await Taro.$showCaptcha();
    
    if (result.success) {
      // éªŒè¯æˆåŠŸï¼Œç»§ç»­ä¸šåŠ¡é€»è¾‘
      console.log('éªŒè¯é€šè¿‡ï¼ŒToken:', result.data);
      await submitOrder(result.data);
    } else {
      // éªŒè¯å¤±è´¥
      Taro.showToast({
        title: result.error || 'éªŒè¯å¤±è´¥',
        icon: 'none',
      });
    }
  };
  
  return <Button onClick={handleSubmit}>æäº¤è®¢å•</Button>;
};
```

### 6.3 åœ¨é¡µé¢ä¸­é›†æˆ

```typescript
// src/layout/index.tsx
import GlobalComponent from '@/components/GlobalComponent';

const Layout = ({ children }) => {
  return (
    <>
      {children}
      {/* å…¨å±€ç»„ä»¶ï¼ˆåŒ…å«éªŒè¯ç ï¼‰ */}
      <GlobalComponent />
    </>
  );
};
```

---

## ä¸ƒã€æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹

### 7.1 å¹¶å‘æ§åˆ¶

RiskControlManager å·²å®ç°å¹¶å‘æ§åˆ¶ï¼Œå¤šä¸ªè¯·æ±‚åŒæ—¶è§¦å‘éªŒè¯æ—¶ï¼Œä¼šå¤ç”¨åŒä¸€ä¸ªéªŒè¯ Promiseï¼š

```typescript
// åŒæ—¶è§¦å‘ä¸¤ä¸ªéœ€è¦éªŒè¯çš„è¯·æ±‚
const [result1, result2] = await Promise.all([
  request1(), // è§¦å‘éªŒè¯
  request2(), // å¤ç”¨éªŒè¯
]);

// ç”¨æˆ·åªéœ€è¦éªŒè¯ä¸€æ¬¡
```

### 7.2 è¶…æ—¶å¤„ç†

é»˜è®¤è¶…æ—¶æ—¶é—´ä¸º 60 ç§’ï¼Œè¶…æ—¶åè‡ªåŠ¨è¿”å›å¤±è´¥ï¼š

```typescript
private readonly VERIFY_TIMEOUT = 60000; // 60ç§’

// ç”¨æˆ·é•¿æ—¶é—´ä¸æ“ä½œ
const result = await Taro.$showCaptcha();
// 60 ç§’åï¼š{ success: false, error: 'éªŒè¯è¶…æ—¶ï¼Œè¯·é‡è¯•' }
```

### 7.3 åˆ†åŒ…åœºæ™¯æ³¨æ„äº‹é¡¹

åœ¨é¾™æ¹–é¡¹ç›®ä½œä¸ºåˆ†åŒ…æ—¶ï¼š
- âœ… `setup.ts` ä¸­çš„å…¨å±€æ–¹æ³•åœ¨åº”ç”¨å¯åŠ¨æ—¶å®šä¹‰
- âœ… æ¯ä¸ªé¡µé¢çš„ `GlobalComponent` ç‹¬ç«‹ç›‘å¬è‡ªå·±çš„äº‹ä»¶
- âœ… äº‹ä»¶é€šè¿‡é¡µé¢ ID è‡ªåŠ¨è·¯ç”±ï¼Œä¸ä¼šä¸²é¡µé¢
- âš ï¸ æ³¨æ„æ£€æŸ¥ `Taro.$showCaptcha` æ˜¯å¦å·²å®šä¹‰ï¼ˆåˆ†åŒ…å¯èƒ½å»¶è¿ŸåŠ è½½ï¼‰

### 7.4 é”™è¯¯å¤„ç†

```typescript
// æ¨èçš„é”™è¯¯å¤„ç†æ–¹å¼
try {
  const result = await Taro.$showCaptcha();
  
  if (result.success) {
    // éªŒè¯æˆåŠŸ
    console.log('Token:', result.data);
  } else {
    // éªŒè¯å¤±è´¥ï¼ˆç”¨æˆ·å–æ¶ˆã€è¶…æ—¶ç­‰ï¼‰
    console.warn('éªŒè¯å¤±è´¥:', result.error);
    Taro.showToast({ title: result.error, icon: 'none' });
  }
} catch (error) {
  // å¼‚å¸¸æƒ…å†µï¼ˆç½‘ç»œé”™è¯¯ã€ç³»ç»Ÿé”™è¯¯ç­‰ï¼‰
  console.error('éªŒè¯å¼‚å¸¸:', error);
  Taro.showToast({ title: 'éªŒè¯ç³»ç»Ÿå¼‚å¸¸', icon: 'none' });
}
```

---

## å…«ã€æ€§èƒ½ä¼˜åŒ–

### 8.1 æ‡’åŠ è½½ä¼˜åŒ–

`DxCaptcha` ç»„ä»¶æ ¹æ®å¹³å°åŠ¨æ€åŠ è½½å®ç°ï¼š

```typescript
// src/components/DxCaptcha/index.tsx
let DxCaptchaImpl;

if (process.env.TARO_ENV === 'weapp') {
  DxCaptchaImpl = require('./weapp').default;  // å°ç¨‹åºå®ç°
} else {
  DxCaptchaImpl = require('./web').default;    // H5 å®ç°
}
```

### 8.2 äº‹ä»¶é˜Ÿåˆ—æœºåˆ¶

é˜²æ­¢é¡µé¢è¿˜æœªåˆå§‹åŒ–æ—¶äº‹ä»¶ä¸¢å¤±ï¼š

```typescript
// setup.ts
if ((Taro.eventCenter as any).callbacks[eventName]) {
  Taro.eventCenter.trigger(eventName, options);
} else {
  // äº‹ä»¶æœªç»‘å®šï¼Œæ”¾å…¥é˜Ÿåˆ—
  eventQueue.push({ eventName, options });
  
  // ç­‰å¾…é¡µé¢åˆå§‹åŒ–å®Œæˆåè§¦å‘
  Taro.eventCenter.on(initedEventName, () => {
    eventQueue.forEach(item => {
      Taro.eventCenter.trigger(item.eventName, item.options);
    });
  });
}
```

---

## ä¹ã€æ€»ç»“

### 9.1 æ ¸å¿ƒä¼˜åŠ¿

1. **æ¶æ„ä¼˜é›…**ï¼šäº‹ä»¶å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œè°ƒç”¨æ–¹ä¸å®ç°æ–¹å®Œå…¨è§£è€¦
2. **è‡ªåŠ¨è·¯ç”±**ï¼šåˆ©ç”¨å°ç¨‹åº/Taro åº•å±‚æœºåˆ¶ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤æ˜ å°„è¡¨
3. **ä»£ç ç®€æ´**ï¼šå‡å°‘çº¦ 37.5% ä»£ç é‡ï¼Œé™ä½ç»´æŠ¤æˆæœ¬
4. **ç±»å‹å®‰å…¨**ï¼šå®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
5. **å¹¶å‘å®‰å…¨**ï¼šè‡ªåŠ¨å¤„ç†å¹¶å‘è¯·æ±‚ï¼Œé¿å…é‡å¤éªŒè¯
6. **è¶…æ—¶æ§åˆ¶**ï¼šé˜²æ­¢ç”¨æˆ·é•¿æ—¶é—´ä¸æ“ä½œå¯¼è‡´è¯·æ±‚æŒ‚èµ·

### 9.2 æŠ€æœ¯äº®ç‚¹

1. **åˆ©ç”¨åº•å±‚æœºåˆ¶**ï¼š`__wxExparserNodeId__` è‡ªåŠ¨ç”Ÿæˆé¡µé¢å”¯ä¸€æ ‡è¯†
2. **Promise é“¾å¼ä¼ é€’**ï¼šä¼˜é›…çš„å¼‚æ­¥å¤„ç†æ–¹æ¡ˆ
3. **äº‹ä»¶é˜Ÿåˆ—**ï¼šé˜²æ­¢æ—¶åºé—®é¢˜å¯¼è‡´äº‹ä»¶ä¸¢å¤±
4. **å•ä¾‹æ¨¡å¼**ï¼šå…¨å±€å…±äº« RiskControlManager å®ä¾‹
5. **è·¨å¹³å°å…¼å®¹**ï¼šé€šè¿‡ Taro é€‚é…å±‚æ”¯æŒå¤šç«¯

### 9.3 æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **åº”ç”¨çº§å•ä¾‹**ï¼šå°† GlobalComponent æå‡åˆ° App çº§åˆ«ï¼ŒçœŸæ­£å®ç°å•å®ä¾‹
2. **éªŒè¯ç»“æœç¼“å­˜**ï¼šçŸ­æ—¶é—´å†…å¤ç”¨éªŒè¯ç»“æœï¼Œå‡å°‘ç”¨æˆ·æ“ä½œ
3. **æ™ºèƒ½é™çº§**ï¼šéªŒè¯å¤±è´¥æ—¶æä¾›é™çº§æ–¹æ¡ˆï¼ˆå¦‚å›¾å½¢éªŒè¯ç  â†’ çŸ­ä¿¡éªŒè¯ç ï¼‰
4. **æ€§èƒ½ç›‘æ§**ï¼šæ·»åŠ éªŒè¯è€—æ—¶ã€æˆåŠŸç‡ç­‰æ•°æ®åŸ‹ç‚¹

---

## åã€å‚è€ƒèµ„æ–™

- [Taro å®˜æ–¹æ–‡æ¡£](https://taro-docs.jd.com/)
- [å¾®ä¿¡å°ç¨‹åºå®˜æ–¹æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [Exparser æ¡†æ¶åŸç†](https://developers.weixin.qq.com/community/develop/article/doc/000c4e433707c072c1793e56f5c813)

---
